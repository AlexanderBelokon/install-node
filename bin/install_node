#!/bin/bash

set -eu

semver_range=$1
platform=$2
output_dir=$3

base="$(dirname $0)/.."
node="$base/vendor/nodejs/bin/node"

# Resolve node version using local semver
node_version=$($node "$base/node_modules/.bin/semver" --range "$semver_range" "$(cat $base/cache/node-versions)" | tail -n 1)

# Output info about requested range and resolved node version
echo "Requested node range:  $semver_range"
echo "Resolved node version: $node_version"
echo "Requested node platform: $platform"

case $platform in
    "linux")
        url="http://nodejs.org/dist/v$node_version/node-v$node_version-linux-x64.tar.gz"
        ;;
    "darwin")
        url="http://nodejs.org/dist/v$node_version/node-v$node_version-darwin-x64.tar.gz"
        ;;
    "win32")
        url="http://nodejs.org/dist/v$node_version/node.exe"
        ;;
    *)
        echo "Not a valid platform. Specify one of linux, darwin or win32"
        exit 1
        ;;
esac

tmp="$(mktemp -d -t install-node.XXXXXX)"
trap "rm -rf $tmp" EXIT

cd "$tmp"
wget --no-verbose "$url"
wget --no-verbose "http://nodejs.org/dist/v$node_version/SHASUMS.txt.asc"

# Verify signed SHASUMS file to ensure it can be trusted
echo "Verifying signature of nodejs SHASUMS.txt.asc"
gpg --verify < "node-v$node_version-SHASUMS.txt.asc"

# Check that shasum of tarball is present
echo "Verifying nodejs shasum"
node_shasum="$(shasum $(basename $url) | grep -oE '^[0-9a-f]+')"
grep "$node_shasum" "node-v$node_version-SHASUMS.txt.asc"

if [ "${url##*.}" == "gz" ]; then
    tar --strip-components 1 -xzf "node-v$node_version-linux-x64.tar.gz" --directory "$output_dir"
else
    cp node.exe "$output_dir/"
fi
