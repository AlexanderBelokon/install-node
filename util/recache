#!/bin/bash

main="$(dirname $0)/../bin/install_node"
cache_dir="$(dirname $0)/../cache"
tmp=$(mktemp -d -t install-node.XXXXXX)
cd "$tmp"

# Cache app to S3
gpg -q --keyserver pgp.mit.edu --recv-keys 6C481CF6 && gpg --export --armor 6C481CF6 > ./izs.asc
gpg -q --keyserver pgp.mit.edu --recv-keys 0246406D && gpg --export --armor 0246406D > ./tjfontaine.asc

s3 cp --acl public-read "$main"           s3://mapbox/apps/install-node/run.sh
s3 cp --acl public-read ./izs.asc         s3://mapbox/apps/isntall-node/cache/izs.asc
s3 cp --acl public-read ./tjfontaine.asc  s3://mapbox/apps/isntall-node/cache/tjfontaine.asc

# Cache node.js packages to S3
versions=( $(cat "$cache_dir/node-versions") )
dest="s3://mapbox/vendor/nodejs/test/"

for nv in "${versions[@]}"; do
    echo "Caching Node.js v$nv to S3"
    wget -q "http://nodejs.org/dist/v$nv/SHASUMS.txt.asc"
    wget -q "http://nodejs.org/dist/v$nv/node-v$nv-linux-x64.tar.gz"
    wget -q "http://nodejs.org/dist/v$nv/node-v$nv-darwin-x64.tar.gz"
    wget -q "http://nodejs.org/dist/v$nv/node.exe"

    aws s3 cp --acl public-read ./SHASUMS.txt.asc              $dest
    aws s3 cp --acl public-read ./node-v$nv-linux-x64.tar.gz   $dest
    aws s3 cp --acl public-read ./node-v$nv-darwin-x64.tar.gz  $dest
    aws s3 cp --acl public-read ./node.exe                     $dest
    rm ./*
done
