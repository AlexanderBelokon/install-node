#!/bin/bash
set -e

main_file="$(dirname $0)/../bin/install_node"
version_file="$(dirname $0)/../cache/node-versions"
versions=( $(cat "$version_file") )
dest="s3://mapbox/vendor/nodejs"
apps_dest="s3://mapbox/apps/install-node"
tmp=$(mktemp -d -t install-node.XXXXXX)
gitsha=$(cd $(dirname $0)  && git rev-parse HEAD)

function cachefile() {
    local filename=$1
    local localname=$(echo $1 | tr '/' '-')
    local nv=$2

    wget -q -O $localname "http://nodejs.org/dist/v$nv/$filename"
    md5sum "$localname" > "$localname.md5"

    if aws s3 cp "$dest/v$nv/$filename.md5" "./$localname-online.md5" > /dev/null 2>&1; then
        if md5sum -c $localname-online.md5; then
            echo "$filename unchanged"
            return 0
        fi
    fi

    aws s3 cp --acl public-read "$localname"      "$dest/v$nv/$filename"
    aws s3 cp --acl public-read "$localname.md5"  "$dest/v$nv/$filename.md5"
}

# Cache app to S3
gpg -q --keyserver pgp.mit.edu --recv-keys 6C481CF6 && gpg --export --armor 6C481CF6 > "$tmp/izs.asc"
gpg -q --keyserver pgp.mit.edu --recv-keys 0246406D && gpg --export --armor 0246406D > "$tmp/tjfontaine.asc"
gpg -q --keyserver pgp.mit.edu --recv-keys 888C628D && gpg --export --armor 888C628D > "$tmp/jgilli.asc"

aws s3 cp --acl public-read "$main_file"           $apps_dest/$gitsha/run
aws s3 cp --acl public-read "$tmp/izs.asc"         $apps_dest/cache/
aws s3 cp --acl public-read "$tmp/tjfontaine.asc"  $apps_dest/cache/
aws s3 cp --acl public-read "$tmp/jgilli.asc"      $apps_dest/cache/
aws s3 cp --acl public-read "$version_file"        $apps_dest/cache/

if git describe --tags --exact-match 2> /dev/null; then
    tag=$(git describe --tags --exact-match)
    aws s3 cp --acl public-read "$main_file"           $apps_dest/$tag/run
fi

cd "$tmp"

# Cache node.js packages to S3
for nv in "${versions[@]}"; do
    echo "Caching Node.js v$nv to S3"

    cachefile SHASUMS.txt.asc $nv
    cachefile node-v$nv-linux-x64.tar.gz $nv
    cachefile node-v$nv-darwin-x64.tar.gz $nv
    cachefile node.exe $nv
    cachefile x64/node.exe $nv

    rm ./*
done
